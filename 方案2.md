# æ–¹æ¡ˆ2ï¼šDockerå®¹å™¨ + ç‹¬ç«‹ç½‘ç»œ

## æ¦‚è¿°

é€šè¿‡Dockerå®¹å™¨åˆ›å»ºç‹¬ç«‹çš„ç½‘ç»œç¯å¢ƒï¼Œå°†wenyan-mcpéƒ¨ç½²åœ¨å®¹å™¨ä¸­ï¼Œé¿å…VPNå¯¼è‡´çš„IPå˜åŒ–é—®é¢˜ï¼Œå®ç°ç¨³å®šçš„æ–‡ç« å‘å¸ƒåŠŸèƒ½ã€‚

## ä¼˜åŠ¿

âœ… **ç½‘ç»œéš”ç¦»**ï¼šå®¹å™¨æœ‰ç‹¬ç«‹çš„ç½‘ç»œç¯å¢ƒï¼Œä¸å—ä¸»æœºVPNå½±å“
âœ… **ç¯å¢ƒä¸€è‡´æ€§**ï¼šå®¹å™¨å†…ç¯å¢ƒå›ºå®šï¼Œä¸ä¾èµ–ä¸»æœºç¯å¢ƒ
âœ… **æ˜“äºéƒ¨ç½²**ï¼šä¸€é”®å¯åŠ¨/åœæ­¢ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†
âœ… **å®‰å…¨æ€§**ï¼šå®¹å™¨ä¸ä¸»æœºéš”ç¦»ï¼Œä¸ä¼šå½±å“ä¸»æœºç¯å¢ƒ
âœ… **å¯ç§»æ¤æ€§**ï¼šå¯ä»¥åœ¨ä»»ä½•å®‰è£…äº†Dockerçš„æœºå™¨ä¸Šè¿è¡Œ

## åŠ£åŠ¿

âŒ **å­¦ä¹ æˆæœ¬**ï¼šéœ€è¦äº†è§£DockeråŸºç¡€çŸ¥è¯†
âŒ **èµ„æºæ¶ˆè€—**ï¼šDockeræœ¬èº«å ç”¨ç³»ç»Ÿèµ„æº
âŒ **é…ç½®å¤æ‚**ï¼šéœ€è¦è®¾ç½®ç½‘ç»œå’Œç«¯å£æ˜ å°„

## å…³äºè·¨è®¾å¤‡ä½¿ç”¨

**é‡è¦è¯´æ˜**ï¼šä½¿ç”¨æ–¹æ¡ˆ2åï¼Œå³ä½¿æ¢åˆ°å¦ä¸€å°ç¬”è®°æœ¬ç”µè„‘ï¼Œæ‚¨ä»ç„¶éœ€è¦ï¼š

1. **åœ¨æ–°è®¾å¤‡ä¸Šå®‰è£…Docker**
2. **é‡æ–°é…ç½®IPç™½åå•**ï¼ˆæ–°è®¾å¤‡çš„IPä¼šä¸åŒï¼‰
3. **é‡æ–°éƒ¨ç½²å®¹å™¨**

**ä¸æ˜¯**"ç›¸å½“äºè¿˜æ˜¯åœ¨åŸæ¥çš„IPåœ°å€å‘æ–‡ç« "ï¼Œè€Œæ˜¯ï¼š
- æ¯å°è®¾å¤‡éƒ½æœ‰è‡ªå·±çš„IPåœ°å€
- éœ€è¦åœ¨å¾®ä¿¡å…¬ä¼—å·åå°ä¸ºæ¯å°è®¾å¤‡æ·»åŠ IPç™½åå•
- å®¹å™¨åªæ˜¯è§£å†³äº†å•å°è®¾å¤‡ä¸ŠVPNå¯¼è‡´çš„IPå˜åŒ–é—®é¢˜

## å®ç°æ­¥éª¤

### 1. å®‰è£…Docker

```bash
# macOSå®‰è£…Docker Desktop
brew install --cask docker

# å¯åŠ¨Docker Desktop
open /Applications/Docker.app
```

### 2. æ„å»ºDockeré•œåƒ

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
docker build -t wenyan-mcp .

# æŸ¥çœ‹æ„å»ºçš„é•œåƒ
docker images | grep wenyan-mcp
```

### 3. åˆ›å»ºDockerç½‘ç»œ

```bash
# åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ
docker network create wenyan-network

# æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨
docker network ls
```

### 4. åˆ›å»ºDocker Composeé…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  wenyan-mcp:
    image: wenyan-mcp
    container_name: wenyan-mcp-publisher
    restart: unless-stopped
    networks:
      wenyan-network:
        ipv4_address: 172.20.0.2
    environment:
      - WECHAT_APP_ID=wxae7dd3f82a7b0976
      - WECHAT_APP_SECRET=958c1e19fe39bdbc68c4d2ec87cf6537
      - HOST_IMAGE_PATH=/Users/dabaobaodemac/Desktop/Articles/images
    volumes:
      - /Users/dabaobaodemac/Desktop/Articles:/mnt/host-downloads
      - /Users/dabaobaodemac/Desktop/Articles/images:/mnt/host-images
    ports:
      - "3000:3000"  # å¯é€‰ï¼šå¦‚æœéœ€è¦Webç•Œé¢
    command: ["node", "dist/index.js"]

networks:
  wenyan-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 5. åˆ›å»ºå¯åŠ¨è„šæœ¬

```bash
#!/bin/bash
# start-docker-publisher.sh

echo "ğŸ³ å¯åŠ¨Dockeræ–‡ç« å‘å¸ƒæœåŠ¡..."

# æ£€æŸ¥Dockeræ˜¯å¦è¿è¡Œ
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Dockeræœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨Docker Desktop"
    exit 1
fi

# æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
if ! docker images | grep -q wenyan-mcp; then
    echo "ğŸ”¨ æ„å»ºDockeré•œåƒ..."
    docker build -t wenyan-mcp .
fi

# åˆ›å»ºç½‘ç»œï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if ! docker network ls | grep -q wenyan-network; then
    echo "ğŸŒ åˆ›å»ºDockerç½‘ç»œ..."
    docker network create wenyan-network
fi

# åˆ›å»ºå¿…è¦çš„ç›®å½•
mkdir -p ~/Desktop/Articles
mkdir -p ~/Desktop/Articles/images
mkdir -p ~/Desktop/Articles/processed

# å¯åŠ¨å®¹å™¨
echo "ğŸš€ å¯åŠ¨å®¹å™¨..."
docker-compose up -d

echo "âœ… æœåŠ¡å·²å¯åŠ¨ï¼"
echo "ğŸ“ æ–‡ç« ç›®å½•: ~/Desktop/Articles"
echo "ğŸ–¼ï¸  å›¾ç‰‡ç›®å½•: ~/Desktop/Articles/images"
echo ""
echo "ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ—¥å¿—:"
echo "docker-compose logs -f wenyan-mcp"
```

### 6. åˆ›å»ºç›‘æ§è„šæœ¬

```javascript
// docker-monitor.js
const fs = require('fs');
const path = require('path');
const { exec } = require('child_process');

const WATCH_DIR = '/Users/dabaobaodemac/Desktop/Articles';
const PROCESSED_DIR = '/Users/dabaobaodemac/Desktop/Articles/processed';

// ç¡®ä¿ç›®å½•å­˜åœ¨
if (!fs.existsSync(WATCH_DIR)) {
    fs.mkdirSync(WATCH_DIR, { recursive: true });
}
if (!fs.existsSync(PROCESSED_DIR)) {
    fs.mkdirSync(PROCESSED_DIR, { recursive: true });
}

// é€šè¿‡Dockerå®¹å™¨å‘å¸ƒæ–‡ç« 
async function publishArticle(filePath) {
    return new Promise((resolve, reject) => {
        const fileName = path.basename(filePath);
        const content = fs.readFileSync(filePath, 'utf8');
        
        // åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç”¨äºDockerå®¹å™¨è¯»å–
        const tempFile = path.join(WATCH_DIR, `temp_${fileName}`);
        fs.writeFileSync(tempFile, content);
        
        // é€šè¿‡Dockerå®¹å™¨å¤„ç†
        const command = `docker exec wenyan-mcp-publisher node -e "
            const fs = require('fs');
            const { publishToDraft } = require('./dist/publish');
            
            const content = fs.readFileSync('/mnt/host-downloads/temp_${fileName}', 'utf8');
            const frontmatterMatch = content.match(/^---\\n([\\s\\S]*?)\\n---\\n([\\s\\S]*)$/);
            
            if (frontmatterMatch) {
                const frontmatter = frontmatterMatch[1];
                const body = frontmatterMatch[2];
                
                const titleMatch = frontmatter.match(/title:\\s*(.+)/);
                const coverMatch = frontmatter.match(/cover:\\s*(.+)/);
                
                const title = titleMatch ? titleMatch[1].trim() : 'æœªå‘½åæ–‡ç« ';
                const cover = coverMatch ? coverMatch[1].trim() : '';
                
                publishToDraft(title, body, cover).then(result => {
                    console.log('SUCCESS:' + JSON.stringify(result));
                }).catch(error => {
                    console.log('ERROR:' + error.message);
                });
            }
        "`;
        
        exec(command, (error, stdout, stderr) => {
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            if (fs.existsSync(tempFile)) {
                fs.unlinkSync(tempFile);
            }
            
            if (error) {
                console.error(`âŒ å‘å¸ƒå¤±è´¥: ${error.message}`);
                reject(error);
                return;
            }
            
            if (stdout.includes('SUCCESS:')) {
                const result = JSON.parse(stdout.split('SUCCESS:')[1]);
                console.log(`âœ… æ–‡ç« å‘å¸ƒæˆåŠŸï¼åª’ä½“ID: ${result.media_id}`);
                
                // ç§»åŠ¨æ–‡ä»¶åˆ°å·²å¤„ç†ç›®å½•
                const processedPath = path.join(PROCESSED_DIR, fileName);
                fs.renameSync(filePath, processedPath);
                console.log(`ğŸ“ æ–‡ä»¶å·²ç§»åŠ¨åˆ°: ${processedPath}`);
                
                resolve(result);
            } else if (stdout.includes('ERROR:')) {
                const errorMsg = stdout.split('ERROR:')[1];
                console.error(`âŒ å‘å¸ƒå¤±è´¥: ${errorMsg}`);
                reject(new Error(errorMsg));
            }
        });
    });
}

// ç›‘æ§æ–‡ä»¶å˜åŒ–
function startWatching() {
    console.log(`ğŸ” å¼€å§‹ç›‘æ§ç›®å½•: ${WATCH_DIR}`);
    console.log(`ğŸ“ å·²å¤„ç†æ–‡ä»¶å°†ç§»åŠ¨åˆ°: ${PROCESSED_DIR}`);
    console.log('æŒ‰ Ctrl+C åœæ­¢ç›‘æ§\n');
    
    fs.watch(WATCH_DIR, (eventType, filename) => {
        if (eventType === 'rename' && filename && filename.endsWith('.md') && !filename.startsWith('temp_')) {
            const filePath = path.join(WATCH_DIR, filename);
            
            setTimeout(() => {
                if (fs.existsSync(filePath)) {
                    publishArticle(filePath).catch(console.error);
                }
            }, 1000);
        }
    });
}

// å¯åŠ¨ç›‘æ§
startWatching();
```

## ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨DockeræœåŠ¡

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬
chmod +x start-docker-publisher.sh
./start-docker-publisher.sh

# æ–¹æ³•2ï¼šæ‰‹åŠ¨å¯åŠ¨
docker-compose up -d
```

### 2. å¯åŠ¨æ–‡ä»¶ç›‘æ§

```bash
# åœ¨æ–°çš„ç»ˆç«¯çª—å£è¿è¡Œ
node docker-monitor.js
```

### 3. å‘å¸ƒæ–‡ç« 

1. å°†Markdownæ–‡ç« ä¿å­˜åˆ° `~/Desktop/Articles/` ç›®å½•
2. å°†å›¾ç‰‡æ–‡ä»¶ä¿å­˜åˆ° `~/Desktop/Articles/images/` ç›®å½•
3. ç¡®ä¿æ–‡ç« åŒ…å«æ­£ç¡®çš„frontmatteræ ¼å¼
4. ç›‘æ§è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å‘å¸ƒåˆ°å…¬ä¼—å·è‰ç¨¿ç®±

## æ–‡ç« æ ¼å¼è¦æ±‚

```markdown
---
title: æ–‡ç« æ ‡é¢˜
cover: /mnt/host-images/cover.jpg
---

æ–‡ç« å†…å®¹...
```

## ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹å®¹å™¨çŠ¶æ€

```bash
# æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
docker ps

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs -f wenyan-mcp

# æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
docker inspect wenyan-mcp-publisher
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢å®¹å™¨
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down --rmi all
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯å®¹å™¨
docker-compose restart

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build
```

## ç½‘ç»œé…ç½®

### æŸ¥çœ‹å®¹å™¨ç½‘ç»œ

```bash
# æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨
docker network ls

# æŸ¥çœ‹ç½‘ç»œè¯¦æƒ…
docker network inspect wenyan-network

# æŸ¥çœ‹å®¹å™¨IP
docker inspect wenyan-mcp-publisher | grep IPAddress
```

### æµ‹è¯•ç½‘ç»œè¿æ¥

```bash
# è¿›å…¥å®¹å™¨æµ‹è¯•ç½‘ç»œ
docker exec -it wenyan-mcp-publisher ping api.weixin.qq.com

# æµ‹è¯•å¾®ä¿¡APIè¿æ¥
docker exec -it wenyan-mcp-publisher curl -s "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=wxae7dd3f82a7b0976&secret=958c1e19fe39bdbc68c4d2ec87cf6537"
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å®¹å™¨å¯åŠ¨å¤±è´¥**
   ```bash
   # æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
   docker-compose logs wenyan-mcp
   
   # æ£€æŸ¥ç«¯å£å ç”¨
   lsof -i :3000
   ```

2. **ç½‘ç»œè¿æ¥é—®é¢˜**
   ```bash
   # æ£€æŸ¥å®¹å™¨ç½‘ç»œ
   docker exec wenyan-mcp-publisher ip addr
   
   # æµ‹è¯•å¤–ç½‘è¿æ¥
   docker exec wenyan-mcp-publisher curl -I https://www.baidu.com
   ```

3. **æ–‡ä»¶æƒé™é—®é¢˜**
   ```bash
   # æ£€æŸ¥ç›®å½•æƒé™
   ls -la ~/Desktop/Articles
   
   # ä¿®æ”¹æƒé™
   chmod 755 ~/Desktop/Articles
   ```

### é‡ç½®ç¯å¢ƒ

```bash
# å®Œå…¨é‡ç½®Dockerç¯å¢ƒ
docker-compose down --volumes --rmi all
docker network rm wenyan-network
docker system prune -f

# é‡æ–°æ„å»º
./start-docker-publisher.sh
```

## æ€§èƒ½ä¼˜åŒ–

### 1. èµ„æºé™åˆ¶

```yaml
# åœ¨docker-compose.ymlä¸­æ·»åŠ 
services:
  wenyan-mcp:
    # ... å…¶ä»–é…ç½®
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
```

### 2. æ—¥å¿—ç®¡ç†

```yaml
# é™åˆ¶æ—¥å¿—å¤§å°
services:
  wenyan-mcp:
    # ... å…¶ä»–é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

## å®‰å…¨è€ƒè™‘

1. **ç¯å¢ƒå˜é‡å®‰å…¨**ï¼šä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
2. **ç½‘ç»œéš”ç¦»**ï¼šå®¹å™¨ç½‘ç»œä¸ä¸»æœºç½‘ç»œéš”ç¦»
3. **æ–‡ä»¶æƒé™**ï¼šé™åˆ¶å®¹å™¨å¯¹ä¸»æœºæ–‡ä»¶çš„è®¿é—®æƒé™
4. **å®šæœŸæ›´æ–°**ï¼šå®šæœŸæ›´æ–°Dockeré•œåƒå’Œä¾èµ–

## æ€»ç»“

æ–¹æ¡ˆ2é€‚åˆï¼š
- éœ€è¦è§£å†³VPNå¯¼è‡´IPå˜åŒ–é—®é¢˜çš„ç”¨æˆ·
- å¸Œæœ›ç¯å¢ƒç¨³å®šä¸€è‡´çš„ç”¨æˆ·
- æœ‰ä¸€å®šDockeråŸºç¡€çš„ç”¨æˆ·
- éœ€è¦è·¨è®¾å¤‡éƒ¨ç½²çš„ç”¨æˆ·

è™½ç„¶é…ç½®ç›¸å¯¹å¤æ‚ï¼Œä½†èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³ç½‘ç»œç¯å¢ƒé—®é¢˜ï¼Œæä¾›ç¨³å®šçš„å‘å¸ƒæœåŠ¡ã€‚ 
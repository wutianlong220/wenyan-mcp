# 方案1：本地脚本 + 文件监控

## 概述

通过创建一个本地Node.js脚本，监控指定目录的文件变化，当检测到新的Markdown文章时自动发布到微信公众号草稿箱。

## 优势

✅ **简单直接**：不需要安装Docker，直接使用现有代码
✅ **资源消耗低**：只运行一个Node.js脚本，内存占用少
✅ **调试方便**：可以直接在终端看到日志，容易定位问题
✅ **灵活性高**：可以轻松添加新功能，自定义发布逻辑

## 劣势

❌ **IP问题仍然存在**：脚本使用主机网络，VPN会导致IP变化
❌ **环境依赖**：依赖主机的Node.js环境和网络配置

## 实现步骤

### 1. 创建监控脚本

```javascript
// publish-monitor.js
const fs = require('fs');
const path = require('path');
const { publishToDraft } = require('./dist/publish');

// 配置
const WATCH_DIR = '/Users/dabaobaodemac/Desktop/Articles'; // 监控目录
const PROCESSED_DIR = '/Users/dabaobaodemac/Desktop/Articles/processed'; // 已处理目录

// 确保目录存在
if (!fs.existsSync(WATCH_DIR)) {
    fs.mkdirSync(WATCH_DIR, { recursive: true });
}
if (!fs.existsSync(PROCESSED_DIR)) {
    fs.mkdirSync(PROCESSED_DIR, { recursive: true });
}

// 处理文章发布
async function publishArticle(filePath) {
    try {
        console.log(`正在处理文章: ${filePath}`);
        
        // 读取文章内容
        const content = fs.readFileSync(filePath, 'utf8');
        
        // 解析frontmatter
        const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
        if (!frontmatterMatch) {
            throw new Error('文章格式错误，缺少frontmatter');
        }
        
        const frontmatter = frontmatterMatch[1];
        const body = frontmatterMatch[2];
        
        // 提取标题和封面
        const titleMatch = frontmatter.match(/title:\s*(.+)/);
        const coverMatch = frontmatter.match(/cover:\s*(.+)/);
        
        const title = titleMatch ? titleMatch[1].trim() : '未命名文章';
        const cover = coverMatch ? coverMatch[1].trim() : '';
        
        // 发布文章
        const result = await publishToDraft(title, body, cover);
        
        console.log(`✅ 文章发布成功！媒体ID: ${result.media_id}`);
        
        // 移动文件到已处理目录
        const fileName = path.basename(filePath);
        const processedPath = path.join(PROCESSED_DIR, fileName);
        fs.renameSync(filePath, processedPath);
        
        console.log(`📁 文件已移动到: ${processedPath}`);
        
    } catch (error) {
        console.error(`❌ 发布失败: ${error.message}`);
    }
}

// 监控文件变化
function startWatching() {
    console.log(`🔍 开始监控目录: ${WATCH_DIR}`);
    console.log(`📁 已处理文件将移动到: ${PROCESSED_DIR}`);
    console.log('按 Ctrl+C 停止监控\n');
    
    fs.watch(WATCH_DIR, (eventType, filename) => {
        if (eventType === 'rename' && filename && filename.endsWith('.md')) {
            const filePath = path.join(WATCH_DIR, filename);
            
            // 等待文件写入完成
            setTimeout(() => {
                if (fs.existsSync(filePath)) {
                    publishArticle(filePath);
                }
            }, 1000);
        }
    });
}

// 启动监控
startWatching();
```

### 2. 创建启动脚本

```bash
#!/bin/bash
# start-publisher.sh

echo "🚀 启动文章发布监控..."
echo "请确保已关闭VPN以确保IP稳定"
echo ""

# 检查环境变量
if [ -z "$WECHAT_APP_ID" ] || [ -z "$WECHAT_APP_SECRET" ]; then
    echo "❌ 请设置环境变量:"
    echo "export WECHAT_APP_ID=your_app_id"
    echo "export WECHAT_APP_SECRET=your_app_secret"
    exit 1
fi

# 启动监控脚本
node publish-monitor.js
```

### 3. 创建配置文件

```json
// config.json
{
  "watchDir": "/Users/dabaobaodemac/Desktop/Articles",
  "processedDir": "/Users/dabaobaodemac/Desktop/Articles/processed",
  "themes": {
    "default": "default",
    "vibrant": "orangeheart",
    "colorful": "rainbow"
  },
  "autoPublish": true,
  "backupEnabled": true
}
```

## 使用方法

### 1. 设置环境变量

```bash
export WECHAT_APP_ID=wxae7dd3f82a7b0976
export WECHAT_APP_SECRET=958c1e19fe39bdbc68c4d2ec87cf6537
```

### 2. 创建文章目录

```bash
mkdir -p ~/Desktop/Articles
mkdir -p ~/Desktop/Articles/processed
```

### 3. 启动监控

```bash
# 方法1：直接运行
node publish-monitor.js

# 方法2：使用启动脚本
chmod +x start-publisher.sh
./start-publisher.sh
```

### 4. 发布文章

1. 将Markdown文章保存到 `~/Desktop/Articles/` 目录
2. 确保文章包含正确的frontmatter格式
3. 脚本会自动检测并发布到公众号草稿箱
4. 已处理的文章会移动到 `processed` 目录

## 文章格式要求

```markdown
---
title: 文章标题
cover: /path/to/cover/image.jpg
---

文章内容...
```

## 注意事项

1. **网络环境**：发布前请关闭VPN以确保IP稳定
2. **文件格式**：只处理 `.md` 文件
3. **错误处理**：发布失败的文件会保留在原目录
4. **日志查看**：所有操作日志都会在终端显示

## 故障排除

### 常见问题

1. **IP白名单错误**
   - 确保当前IP已添加到微信公众号IP白名单
   - 使用 `curl ifconfig.me` 查看当前IP

2. **权限错误**
   - 确保脚本有读写目录的权限
   - 检查文件路径是否正确

3. **网络连接错误**
   - 检查网络连接
   - 确认微信公众号配置正确

## 扩展功能

### 1. 添加主题选择

```javascript
// 在frontmatter中添加主题
---
title: 文章标题
cover: /path/to/cover/image.jpg
theme: orangeheart
---
```

### 2. 添加定时发布

```javascript
// 添加定时功能
const schedule = require('node-schedule');

// 每天上午9点发布
schedule.scheduleJob('0 9 * * *', () => {
    console.log('定时发布任务开始...');
    // 处理待发布文章
});
```

### 3. 添加邮件通知

```javascript
// 发布成功后发送邮件通知
const nodemailer = require('nodemailer');

async function sendNotification(title, status) {
    // 邮件发送逻辑
}
```

## 总结

方案1适合：
- 不想学习Docker的用户
- 偶尔发布文章的场景
- 可以接受手动管理网络的用户
- 需要高度自定义功能的用户

虽然存在IP变化的问题，但通过合理的网络管理，仍然是一个实用的解决方案。 
# å¾®ä¿¡å…¬ä¼—å·æ–‡ç« å‘å¸ƒå·¥å…· - æˆåŠŸç»éªŒæ€»ç»“

## é¡¹ç›®èƒŒæ™¯

å¼€å‘ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ç›‘æ§è„šæœ¬ï¼Œè‡ªåŠ¨å°†Markdownæ–‡ç« å‘å¸ƒåˆ°å¾®ä¿¡å…¬ä¼—å·è‰ç¨¿ç®±ã€‚æ–‡ç« å’Œå›¾ç‰‡éƒ½æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸­ï¼Œå®ç°è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹ã€‚

## é‡åˆ°çš„é—®é¢˜åŠè§£å†³è¿‡ç¨‹

### 1. ç¯å¢ƒå˜é‡åŠ è½½é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
- æœ€åˆä½¿ç”¨ `env.local` æ–‡ä»¶å­˜å‚¨ç¯å¢ƒå˜é‡
- ä½† `publish.js` åœ¨æ¨¡å—åŠ è½½æ—¶å°±è¯»å–äº†ç¯å¢ƒå˜é‡ï¼Œè€Œæˆ‘ä»¬çš„ç¯å¢ƒå˜é‡æ˜¯åœ¨è¿è¡Œæ—¶è®¾ç½®çš„
- å¯¼è‡´ `process.env.WECHAT_APP_ID` å’Œ `process.env.WECHAT_APP_SECRET` å§‹ç»ˆä¸ºç©º

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// ä¿®æ”¹å‰ï¼šæ¨¡å—åŠ è½½æ—¶è¯»å–
const appId = process.env.WECHAT_APP_ID || "";
const appSecret = process.env.WECHAT_APP_SECRET || "";

// ä¿®æ”¹åï¼šå‡½æ•°è°ƒç”¨æ—¶åŠ¨æ€è¯»å–
function getAppId(): string {
    return process.env.WECHAT_APP_ID || "";
}

function getAppSecret(): string {
    return process.env.WECHAT_APP_SECRET || "";
}
```

**å…³é”®ç»éªŒï¼š**
- ç¯å¢ƒå˜é‡å¿…é¡»åœ¨è¿è¡Œæ—¶åŠ¨æ€è¯»å–ï¼Œè€Œä¸æ˜¯åœ¨æ¨¡å—åŠ è½½æ—¶é™æ€è¯»å–
- ä½¿ç”¨å‡½æ•°å°è£…ç¯å¢ƒå˜é‡è¯»å–ï¼Œç¡®ä¿æ¯æ¬¡è°ƒç”¨éƒ½èƒ½è·å–æœ€æ–°å€¼

### 2. ESæ¨¡å—å…¼å®¹æ€§é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
- é¡¹ç›®ä½¿ç”¨ESæ¨¡å—ï¼ˆ`"type": "module"`ï¼‰
- ä½†è„šæœ¬ä½¿ç”¨äº†CommonJSçš„ `require()` è¯­æ³•
- å¯¼è‡´ `ReferenceError: require is not defined in ES module scope`

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// ä¿®æ”¹å‰ï¼šCommonJSè¯­æ³•
const fs = require('fs');
const path = require('path');
const { publishToDraft } = require('./dist/publish');

// ä¿®æ”¹åï¼šESæ¨¡å—è¯­æ³•
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { publishToDraft } from './dist/publish.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
```

**å…³é”®ç»éªŒï¼š**
- åœ¨ESæ¨¡å—ç¯å¢ƒä¸­ï¼Œå¿…é¡»ä½¿ç”¨ `import` è¯­æ³•
- éœ€è¦æ‰‹åŠ¨æ„å»º `__dirname` å’Œ `__filename`ï¼Œå› ä¸ºESæ¨¡å—ä¸­æ²¡æœ‰è¿™äº›å˜é‡

### 3. å›¾ç‰‡ä¸Šä¼ çš„æ ¸å¿ƒé—®é¢˜

**é—®é¢˜æè¿°ï¼š**
- ä½¿ç”¨ `formdata-node` åº“ç”ŸæˆFormData
- å¾®ä¿¡APIè¿”å› `41005` é”™è¯¯ï¼š`media data missing`
- æ–‡ä»¶è¯»å–æ­£å¸¸ï¼Œä½†APIæ— æ³•è¯†åˆ«ä¸Šä¼ çš„æ•°æ®

**æ ¹æœ¬åŸå› ï¼š**
- `formdata-node` ç”Ÿæˆçš„multipart/form-dataæ ¼å¼ä¸å¾®ä¿¡APIä¸å®Œå…¨å…¼å®¹
- Node.jsçš„ `fetch` + `formdata-node` ç»„åˆåœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// ä¿®æ”¹å‰ï¼šä½¿ç”¨formdata-node
import { FormData, File } from 'formdata-node';
import { fileFromPath } from 'formdata-node/file-from-path';

const form = new FormData();
form.append("media", fileData, fileName);
const response = await fetch(url, {
    method: 'POST',
    body: form as any,
});

// ä¿®æ”¹åï¼šä½¿ç”¨form-data + node-fetch
import FormData from 'form-data';
import fetch from 'node-fetch';

const form = new FormData();
form.append('media', fileData, { filename: fileName });
const response = await fetch(url, {
    method: 'POST',
    body: form,
    headers: form.getHeaders(),
});
```

**å…³é”®ç»éªŒï¼š**
- `form-data` åº“ä¸“é—¨ä¸ºNode.jsè®¾è®¡ï¼Œä¸å„ç§APIå…¼å®¹æ€§æ›´å¥½
- `node-fetch@2` æ¯”åŸç”Ÿfetchæ›´ç¨³å®šï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†FormDataæ—¶
- å¿…é¡»è®¾ç½®æ­£ç¡®çš„headersï¼š`form.getHeaders()`

### 4. æ–‡ä»¶è·¯å¾„å¤„ç†é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
- å›¾ç‰‡ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ `cover-image.jpg`ï¼‰
- ä½†ä¸Šä¼ å‡½æ•°éœ€è¦ç»å¯¹è·¯å¾„
- è·¯å¾„è½¬æ¢é€»è¾‘å¤æ‚ä¸”å®¹æ˜“å‡ºé”™

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// ç®€åŒ–è·¯å¾„å¤„ç†é€»è¾‘
async function uploadImage(imageUrl: string, accessToken: string, fileName?: string): Promise<UploadResponse> {
    if (imageUrl.startsWith("http")) {
        // å¤„ç†ç½‘ç»œå›¾ç‰‡
        const response = await fetch(imageUrl);
        const buffer = await response.buffer();
        const fileNameFromUrl = fileName || imageUrl.split('/').pop() || 'image.jpg';
        return await uploadMaterial('image', buffer, fileNameFromUrl, accessToken);
    } else {
        // å¤„ç†æœ¬åœ°å›¾ç‰‡
        let localImagePath = imageUrl;
        if (!path.isAbsolute(imageUrl)) {
            localImagePath = path.resolve('/Users/dabaobaodemac/Desktop/Articles', imageUrl);
        }
        if (!fs.existsSync(localImagePath)) {
            throw new Error(`å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨: ${localImagePath}`);
        }
        const buffer = fs.readFileSync(localImagePath);
        const fileNameFromLocal = fileName || path.basename(localImagePath);
        return await uploadMaterial('image', buffer, fileNameFromLocal, accessToken);
    }
}
```

**å…³é”®ç»éªŒï¼š**
- ç»Ÿä¸€ä½¿ç”¨Bufferå¤„ç†æ–‡ä»¶ï¼Œé¿å…ç±»å‹è½¬æ¢é—®é¢˜
- ç®€åŒ–è·¯å¾„é€»è¾‘ï¼Œå‡å°‘å‡ºé”™å¯èƒ½
- æ·»åŠ æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥ï¼Œæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

## æœ€ç»ˆæˆåŠŸçš„æŠ€æœ¯æ ˆ

### æ ¸å¿ƒä¾èµ–
```json
{
  "form-data": "^4.0.0",
  "node-fetch": "^2.7.0",
  "@types/node-fetch": "^2.6.11"
}
```

### å…³é”®ä»£ç ç»“æ„
```typescript
// 1. ç¯å¢ƒå˜é‡åŠ¨æ€è¯»å–
function getAppId(): string {
    return process.env.WECHAT_APP_ID || "";
}

// 2. å›¾ç‰‡ä¸Šä¼ ä½¿ç”¨form-data
async function uploadMaterial(type: string, fileData: Buffer, fileName: string, accessToken: string) {
    const form = new FormData();
    form.append('media', fileData, { filename: fileName });
    const response = await fetch(url, {
        method: 'POST',
        body: form,
        headers: form.getHeaders(),
    });
}

// 3. æ–‡ä»¶è¯»å–ä½¿ç”¨Buffer
const buffer = fs.readFileSync(localImagePath);
```

## è°ƒè¯•æŠ€å·§

### 1. åˆ†æ­¥è°ƒè¯•
- å…ˆæµ‹è¯•ç¯å¢ƒå˜é‡åŠ è½½
- å†æµ‹è¯•æ–‡ä»¶è¯»å–
- æœ€åæµ‹è¯•APIè°ƒç”¨

### 2. è¯¦ç»†æ—¥å¿—
```typescript
console.log(`ğŸ“¤ å¼€å§‹ä¸Šä¼ ç´ æ: ${type}, ${fileName}`);
console.log(`ğŸ“Š æ–‡ä»¶æ•°æ®å¤§å°: ${fileData.length} å­—èŠ‚`);
console.log(`ğŸŒ å‘é€è¯·æ±‚åˆ°: ${url}`);
console.log(`ğŸ“¡ å“åº”çŠ¶æ€: ${response.status}`);
console.log(`ğŸ“‹ å“åº”æ•°æ®:`, data);
```

### 3. é”™è¯¯å¤„ç†
```typescript
if (data.errcode) {
    console.error(`âŒ APIé”™è¯¯: ${data.errcode} - ${data.errmsg}`);
    throw new Error(`ä¸Šä¼ å¤±è´¥ï¼Œé”™è¯¯ç ï¼š${data.errcode}ï¼Œé”™è¯¯ä¿¡æ¯ï¼š${data.errmsg}`);
}
```

## æˆåŠŸçš„å…³é”®å› ç´ 

1. **æ­£ç¡®çš„æŠ€æœ¯é€‰å‹**ï¼š`form-data` + `node-fetch@2` ç»„åˆ
2. **ç¯å¢ƒå˜é‡åŠ¨æ€è¯»å–**ï¼šç¡®ä¿è¿è¡Œæ—¶èƒ½è·å–åˆ°æ­£ç¡®çš„é…ç½®
3. **ESæ¨¡å—å…¼å®¹æ€§**ï¼šæ­£ç¡®å¤„ç†æ¨¡å—å¯¼å…¥å’Œè·¯å¾„
4. **è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯**ï¼šå¿«é€Ÿå®šä½é—®é¢˜æ‰€åœ¨
5. **ç®€åŒ–çš„æ–‡ä»¶å¤„ç†**ï¼šç»Ÿä¸€ä½¿ç”¨Bufferï¼Œé¿å…ç±»å‹è½¬æ¢é—®é¢˜

## ç»éªŒæ€»ç»“

1. **APIå…¼å®¹æ€§å¾ˆé‡è¦**ï¼šä¸åŒçš„HTTPå®¢æˆ·ç«¯åº“å¯¹multipart/form-dataçš„å¤„ç†å¯èƒ½ä¸åŒ
2. **ç¯å¢ƒå˜é‡æ—¶æœº**ï¼šå¿…é¡»åœ¨æ­£ç¡®çš„æ—¶æœºè¯»å–ç¯å¢ƒå˜é‡
3. **æ¨¡å—ç³»ç»Ÿä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰ä»£ç éƒ½ä½¿ç”¨ç›¸åŒçš„æ¨¡å—ç³»ç»Ÿ
4. **è°ƒè¯•ä¿¡æ¯å¿…ä¸å¯å°‘**ï¼šè¯¦ç»†çš„æ—¥å¿—èƒ½å¿«é€Ÿå®šä½é—®é¢˜
5. **ç®€åŒ–èƒœäºå¤æ‚**ï¼šç®€å•çš„è§£å†³æ–¹æ¡ˆå¾€å¾€æ›´å¯é 

## æœ€ç»ˆæ•ˆæœ

âœ… ç¯å¢ƒå˜é‡è‡ªåŠ¨åŠ è½½  
âœ… å›¾ç‰‡æ–‡ä»¶æ­£ç¡®ä¸Šä¼   
âœ… æ–‡ç« æˆåŠŸå‘å¸ƒåˆ°å¾®ä¿¡å…¬ä¼—å·è‰ç¨¿ç®±  
âœ… æ”¯æŒç›¸å¯¹è·¯å¾„å›¾ç‰‡å¼•ç”¨  
âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•  

è¿™ä¸ªé¡¹ç›®æˆåŠŸçš„å…³é”®åœ¨äºè§£å†³äº†APIå…¼å®¹æ€§é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å›¾ç‰‡ä¸Šä¼ çš„FormDataæ ¼å¼é—®é¢˜ã€‚é€šè¿‡ä½¿ç”¨ä¸“é—¨ä¸ºNode.jsè®¾è®¡çš„`form-data`åº“ï¼Œæˆ‘ä»¬æˆåŠŸç»•è¿‡äº†`formdata-node`çš„å…¼å®¹æ€§é—®é¢˜ï¼Œæœ€ç»ˆå®ç°äº†ç¨³å®šçš„è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹ã€‚ 